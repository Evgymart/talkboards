version: '3'

vars:
  PHP: '{{if not .LOCALLY}}docker compose exec -it php{{end}}'

env:
  APP_ENV: dev

dotenv:
  - '.env.{{APP_ENV}}.local'
  - '.env.{{APP_ENV}}'
  - '.env.local'
  - '.env'

tasks:
  install:
    cmd: '{{.PHP}} composer install {{.CLI_ARGS}}'
    sources:
      - composer.json
      - composer.lock
    generates:
      - vendor/autoload.php
  up:
    cmds:
      - 'docker compose up --detach --remove-orphans {{.CLI_ARGS}}'
      - task: install
  down: 'docker compose down --remove-orphans {{.CLI_ARGS}}'
  start:
    cmds:
      - 'docker compose start {{.CLI_ARGS}}'
      - task: install
  stop: 'docker compose stop {{.CLI_ARGS}}'
  php: '{{.PHP}} sh'
  test:
    deps: [ install ]
    cmd: '{{.PHP}} vendor/bin/phpunit {{.CLI_ARGS}}'

  fixcs:
    deps: [install]
    cmd: '{{.PHP}} vendor/bin/php-cs-fixer fix --diff --verbose {{.CLI_ARGS}}'
  lint:
    cmds:
      - task: fixcs
        vars:
          CLI_ARGS: "--dry-run {{.CLI_ARGS}}"
